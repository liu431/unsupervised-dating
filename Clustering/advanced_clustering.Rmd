---
title: "Advanced Clustering"
author: "Adam Shelton"
date: "11/11/2019"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(cluster)
library(FactoMineR)
library(factoextra)
library(NbClust)
library(dbscan)
library(cowplot)
# library(doParallel)

knitr::opts_chunk$set(echo = TRUE, fig.height = 10, fig.width = 12, dpi = 400)

set.seed(60615)

# setup_cl = function(seed = round(Sys.time())) {
#   require(parallel)
#   if (exists("cl")) {
#     print("Stopping existing cluster")
#     try(parallel::stopCluster(cl))
#   }
#   assign("cl", parallel::makeCluster(parallel::detectCores() - 1, outfile = "out.txt"), envir = globalenv())
#   RNGkind("L'Ecuyer-CMRG")
#   print(paste("Using", as.numeric(seed), "as parallel RNG seed"))
#   clusterSetRNGStream(cl, seed)
# }
# setup_cl(60615)
# registerDoParallel(cl)
```

## Import Data
```{r data}
#original_data = readRDS(here("Data", "full_ok_cupid_cleaned.rds"))

new_features = read_csv(here("Data", "newfeatures.csv")) %>% select(-X1) %>% as.matrix() %>% scale()
```
## PCA
```{r}
PCA(new_features, graph = FALSE) %>% fviz_pca_biplot(label = "var", col.var = "red", col.ind = "grey")
ggsave2(here("Clustering", "pca.png"), height = 7, width = 11)
```



## CLARA
```{r}
#nb <- NbClust(new_features, distance = "euclidean", min.nc = 2, max.nc = 10, method = "complete", index ="all")

build_clara = function(x) {
  clara(new_features, x)
}

clara_mods = lapply(1:10, build_clara)

clara_viz = lapply(clara_mods[2:10], fviz_cluster, labelsize = 0)
plot_grid(plotlist = clara_viz)

ggsave2(here("Clustering", "clara_all.png"), height = 7, width = 11)

clara_viz[[2]]
ggsave2(here("Clustering", "clara_three.png"), height = 7, width = 11)

```


## Fuzzy
```{r eval=FALSE, include=FALSE}
test = fanny(new_features, 3)
```



## DBSCAN
```{r, warning=FALSE, message=FALSE}
kNNdistplot(new_features, k = ncol(new_features) - 1)
abline(h= 0.5, col = "red", lty=2)
test = dbscan(new_features, 0.5)

fviz_cluster(test, new_features, labelsize = 0)
```

